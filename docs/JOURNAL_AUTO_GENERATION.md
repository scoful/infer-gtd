# 日记自动生成功能

## 概述

日记自动生成功能可以根据您完成的任务自动创建和更新日记内容，支持定时生成和实时触发两种模式。

## 功能特性

### 🔄 双重触发机制

1. **任务完成触发**
   - 完成任务时自动更新当天日记
   - 支持单个任务完成、计时器停止、批量任务完成
   - 实时响应，无需等待

2. **定时任务触发**
   - 每天晚上11:55自动生成日记（可配置）
   - 批量处理所有活跃用户
   - 确保不遗漏任何完成的任务

### 🎯 智能去重

- 检查现有日记内容
- 只添加新完成的任务
- 避免重复生成相同内容
- 保持日记内容的整洁性

### ⚙️ 个性化配置

用户可以在设置页面（`/settings`）配置以下选项：

- **启用/禁用自动生成**：总开关
- **任务完成时自动更新**：实时触发开关
- **每日定时生成**：定时任务开关
- **定时生成时间**：自定义时间（默认23:55）
- **包含信息选择**：
  - 用时信息
  - 项目信息
  - 标签信息

## 使用方法

### 1. 基本使用

1. 每天晚上会自动生成完整的日记内容
2. 可以在日记流页面手动生成日记
3. 管理员可以在系统管理页面手动执行生成

### 2. 个性化设置

1. 访问 `/settings` 页面
2. 在"日记自动生成"选项卡中配置偏好
3. 设置会自动保存

### 3. 手动管理

管理员可以在 `/admin/scheduler` 页面：
- 查看定时任务状态
- 手动执行日记生成
- 监控系统运行状态

## 生成的日记格式

```markdown
# YYYY-MM-DD 日记

## 今日完成
- 任务标题 [项目名称] [优先级] (用时: X小时Y分钟) #标签1 #标签2

## 今日学习
-

## 心得感悟
-

## 遇到的问题
-

## 明日计划
-
```

## 技术实现

### 核心组件

1. **`journal-auto-generator.ts`** - 日记生成核心逻辑
2. **`scheduler.ts`** - 定时任务调度器
3. **`user-settings.ts`** - 用户设置管理
4. **任务路由增强** - 任务完成时的触发机制

### API 端点

- `api.scheduler.getStatus` - 获取调度器状态
- `api.scheduler.executeJournalGeneration` - 手动执行生成
- `api.userSettings.get/update` - 用户设置管理

### 数据库变更

- 在 `User` 表中添加 `settings` 字段（JSON格式）
- 存储用户的个性化配置

## 故障排除

### 常见问题

1. **日记没有自动生成**
   - 检查用户设置是否启用
   - 确认当天有完成的任务
   - 查看调度器运行状态

2. **重复内容**
   - 系统有去重机制，不应出现重复
   - 如果出现，可能是任务标题完全相同导致

3. **定时任务不执行**
   - 检查调度器是否运行
   - 确认服务器时间设置正确
   - 查看系统日志

### 调试工具

- 测试页面：`/test-journal-auto`（开发环境）
- 管理页面：`/admin/scheduler`
- 设置页面：`/settings`

## 最佳实践

1. **任务命名**：使用清晰、描述性的任务标题
2. **项目分类**：合理使用项目来组织任务
3. **标签使用**：添加相关标签便于分类
4. **时间记录**：使用计时器记录准确的用时

## 安全考虑

- 用户设置存储在数据库中，确保数据安全
- 只有用户本人可以访问和修改自己的设置
- 管理员功能需要适当的权限控制

## 未来扩展

- 支持自定义日记模板
- 添加更多触发条件
- 集成AI生成日记摘要
- 支持多语言日记生成
